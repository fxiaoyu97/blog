# 微服务

## 单一架构

![1525529091749](assets/1525529091749.png)

存在的问题：

- 代码耦合，开发维护困难
- 无法针对不同模块进行针对性优化
- 无法水平扩展
- 单点容错率低，并发能力差

## 知识补充

1. 引入依赖版本管理

```xml
<dependencyManagement>
		<dependencies>
            <!-- SpringCloud依赖，一定要放到dependencyManagement中，起到管理版本的作用即可 -->
			<dependency>
				<groupId>org.springframework.cloud</groupId>
				<artifactId>spring-cloud-dependencies</artifactId>
				<version>${spring-cloud.version}</version>
				<type>pom</type>
				<scope>import</scope>
			</dependency>
		</dependencies>
	</dependencyManagement>
```

2. 启动类注解，使用`@EnableDiscoveryClient `开启EurekaClient功能

3. eureka宕机后，服务提供者和服务消费者仍能通过本地缓存通讯。

4. 远程调用技术
   + rpc协议：自定义数据格式，限定技术，传输速度快，效率高 tcp dubbo
   + http协议，统一的数据格式，不限定技术 rest接口，tcp springcloud
   
5. 什么是springcloud
   + 微服务架构的解决方案，是很多组件的集合
   + eureka：注册中心，服务的注册与发现
   + zuul：网关组件，路由请求，过滤器（ribbon hystrix）
   + ribbon：负载均衡组件
   + hystrix：熔断组件
   + feign：远程调用组件（ribbon hystrix）
   
6. eureka
   + 注册中心：itcast-eureka
     1. 引入启动器
     2. 配置spring.application.name=itcast-eureka
     3. 在引导类上@EnableEurekaServer
   + 客户端：itcast-service-provider itcast-service-consumer
     1. 引入启动器
     2. 配置spring.application.name 和 eureka.client.service-url.defaultZone=http://localhost:10086/eurka
     3. @EnableDiscoveryClient（启动eureka客户端）
   
7. 高可用eureka

   启动多个实例

8. 心跳过期 itcast-service-provider

```yaml
eureka:
	instance:
		lease-renewal-interval-in-seconds: 5 #心跳时间
		lease-expiration-duration-in-seconds: 15 #过期时间
```

9. 拉取服务的间隔时间 itcast-service-consumer

```yaml
eureka:
	client:
		registry-fetch-interval-seconds: 5
```

10. 关闭自我保护，定期清除无效连接

```yaml
eureka:
	server:
		eviction-interval-timer-in-ms: 5000
		enable-self-preservation: false
```

## ribbon 负载均衡

1. eureka集成了该组件
2. `@LoadBalanced`：消费方使用，开启负载均衡
3. `this.restTemplate.getForObject("http://service-provider/user/"+id, User.class)`

 