# 熔断和网关

## hystrix 容错组件

### 降级：检查每次请求，是否请求超时，或者连接池已满

1. 引入hystrix启动器
2. 通过`hystrix.command:default.execution.isolation.thread.timeoutInMilliseconds`设置Hystrix的超时时间（默认1s，设置时间长一些）

```yaml
hystrix:
  command:
    default:
      execution:
        isolation:
          thread:
            timeoutInmilliseconds: 6000 # 在服务调用方里面配置
```



3. 在引导类上添加一个注解：`@EnableCircuitBreaker `和`@SpringCloudApplication`
2. 定义熔断方法：局部（要和被熔断的方法返回值和参数列表一致） 全局（返回值类型和被熔断的方法一致，参数列表必须为空）
3. `@HystrixCommand(fallbackMethod="全局方法名")`：声明被熔断的方法
4. `@DefaultProperties(defaultFallback="全局熔断方法名")`注解加在类上，在具体的被熔断方法上@HystrixCommand

### 熔断：不再发送请求

1. close：闭合状态，所有请求正常访问
2. open：打开状态，所有请求都无法访问，如果在一定时间内，失败的比例不小于50%或者次数不少于20次
3. half open：半开状态，打开状态默认5s休眠期，在休眠期所有请求无法正常访问，过了休眠期会进入半开状态，放部分请求通过。

```properties
# 触发熔断的最小请求次数，默认20
circuitBreaker.requestVolumeThreshold=10
# 休眠时长，默认是5000毫秒
circuitBreaker.sleepWindowInMilliseconds=10000
# 触发熔断的失败请求最小占比，默认50%
circuitBreaker.errorThresholdPercentage=50
```

## feign

1. 引入openFeign启动器
2. 配置`feign.hystrix.enable=true`，开启feign的熔断功能
3. 在引导类上使用注解`@EnableFeignClients`
4. 创建一个接口，在接口添加`@FeignClient(value="服务id",fallback=实现类.class)`
5. 在接口中定义一些方法，这些方法的书写方式跟之前controller类似
6. 创建一个熔断类，实现feign接口，实现对应的方法，这些实现方法就是熔断方法

## zuul

1. 引入zuul的启动器
2. 四种配置方式
3. `@EnableZuulProxy`，启动类注解
4. 实现过滤器
   1. 创建一个过滤类继承`ZuulFilter`基类
   2. 重写四种方法
      + filterType：pre、route、post、error
      + filterOrder：返回值越小，优先级越高
      + shouldFilter：是否执行run方法，true执行
      + run：具体的拦截逻辑